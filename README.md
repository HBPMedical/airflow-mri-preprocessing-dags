[![License](https://img.shields.io/badge/license-Apache--2.0-blue.svg)](https://github.com/LREN-CHUV/airflow-mri-preprocessing-dags/blob/master/LICENSE) [![Codacy Badge](https://api.codacy.com/project/badge/Grade/8c5c9dc3cfb8492f870369c973f3cc8c)](https://www.codacy.com/app/hbp-mip/airflow-mri-preprocessing-dags?utm_source=github.com&amp;utm_medium=referral&amp;utm_content=LREN-CHUV/airflow-mri-preprocessing-dags&amp;utm_campaign=Badge_Grade) [![Code Health](https://landscape.io/github/LREN-CHUV/airflow-mri-preprocessing-dags/master/landscape.svg?style=flat)](https://landscape.io/LREN-CHUV/airflow-mri-preprocessing-dags/master)

# Airflow MRI preprocessing DAGs

Requirements:

* airflow-imaging-plugins
* mri-preprocessing-pipeline
* mri-meta-extract

## Setup and configuration

### Airflow setup for MRI scans pipeline:

* Create the following pools:
   * image_preprocessing with N slots, where N is less than the number of vCPUs available on the machine
   * remote_file_copy with N slots, where N should be 1 or 2 to avoid saturating network IO

* In Airflow config file, add the [mri] section with the following entries:
   * DATASETS: comma separated list of datasets to process. Each dataset is configured using a [<dataset>] section in the config file
   * EMAIL_ERRORS_TO: email address to send errors to
   * SLACK_CHANNEL: optional, Slack channel to use to send status messages
   * SLACK_CHANNEL_USER: optional, user to post as in Slack
   * SLACK_TOKEN: optional, authorisation token for Slack
   * SQL_ALCHEMY_CONN: connection URL to the Data catalog database tracking artifacts generated by the MRI pipelines.
   * MIPMAP_DB_CONFILE_FILE: optional, path to the configuration file used by MipMap to connect to its work database.

* For each dataset, add a [<dataset>] section, replacing <dataset> with the actual name of the dataset and define the following entries:
   * DATASET: Name of the dataset
   * DATASET_CONFIG: List of flags:
        - boost: (optional) When enabled, we consider that all the files from a same folder share the same meta-data.
        When enabled, the processing is (about 2 times) faster. This option is enabled by default.
        - session_id_by_patient: Rarely, a data set might use study IDs which are unique by patient (not for the whole study).
        E.g.: LREN data. In such a case, you have to enable this flag. This will use PatientID + StudyID as a session ID.
        - visit_id_in_patient_id: Rarely, a data set might mix patient IDs and visit IDs. E.g. : LREN data. In such a case, you have
        to enable this flag. This will try to split PatientID into VisitID and PatientID.
        - visit_id_from_path: Enable this flag to get the visit ID from the folder hierarchy instead of DICOM meta-data
        (e.g. can be useful for PPMI).
        - repetition_from_path: Enable this flag to get the repetition ID from the folder hierarchy instead of DICOM meta-data
        (e.g. can be useful for PPMI).
   * DICOM_LOCAL_FOLDER: path containing the anonymised files coming from the MRI scanner and already anonymised by a tool
   * DICOM_FILES_PATTERN: pattern used to identify DICOM files. Default: ```**/MR.*```
   * dicom_select_T1_local_folder = /data/select_T1
   * dicom_select_T1_protocols_file = /opt/airflow-scripts/mri-preprocessing-pipeline/Protocols_definition.txt
   * DICOM_SELECT_T1_SPM_FUNCTION: selectT1
   * EHR_SCANNERS
   * EHR_DATA_FOLDER
   * EHR_DATA_FOLDER_DEPTH
   * EHR_TO_I2B2_CAPTURE_DOCKER_IMAGE
   * EHR_TO_I2B2_CAPTURE_FOLDER
   * EHR_VERSIONED_FOLDER
   * IMAGES_ORGANIZER_DATASET_TYPE
   * IMAGES_ORGANIZER_DATA_STRUCTURE PatientID:AcquisitionDate:SeriesDescription:SeriesDate
   * IMAGES_ORGANIZER_LOCAL_FOLDER
   * IMAGES_ORGANIZER_DOCKER_IMAGE
   * max_active_runs = 30
   * MIN_FREE_SPACE_LOCAL_FOLDER: minimum percentage of free space available on local disk
   * MPM_MAPS_LOCAL_FOLDER: path for the results of MPM maps pipeline
   * MPM_MAPS_SERVER_FOLDER: for the results of MPM maps pipeline
   * MPM_MAPS_SPM_FUNCTION: Preproc_mpm_maps
   * neuro_morphometric_atlas_TPM_template = /opt/spm12/tpm/nwTPM_sl3.nii
   * NEURO_MORPHOMETRIC_ATLAS_LOCAL_FOLDER: path for the results of neuro morphometric atlas pipeline
   * NEURO_MORPHOMETRIC_ATLAS_SERVER_FOLDER: long term storage location for the results of neuro morphometric atlas pipeline
   * NEURO_MORPHOMETRIC_ATLAS_SPM_FUNCTION: NeuroMorphometric_pipeline
   * NEURO_MORPHOMETRIC_ATLAS_TPM_TEMPLATE: SPM_DIR + '/tpm/nwTPM_sl3.nii'
   * NIFTI_LOCAL_FOLDER: path for the image files converted to Nifti
   * NIFTI_SERVER_FOLDER: long term storage location for the image files converted to Nifti
   * NIFTI_SPM_FUNCTION: DCM2NII_LREN'
   * PIPELINES_PATH: path to the root folder containing the Matlab scripts for the pipelines
   * PREPROCESSING_DATA_FOLDER:
   * PREPROCESSING_PIPELINES: comma-separated list of values in copy_to_local, dicom_to_nifti, mpm_maps, neuro_morphometric_atlas
     * copy_to_local: copies all DICOM files to COPY_TO_LOCAL_FOLDER.
   * PREPROCESSING_SCANNERS: comma-separated list of values in continuous, daily, flat to select how the preprocessing data folder is scanned for new work.
   * PROTOCOLS_FILE: path to the MRI acquisition protocol file
